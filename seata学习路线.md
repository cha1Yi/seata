# Seata源码分析

Seata最重要的一个分布式事务模式为：AT模式，就是两阶段提交协议的变种

准备阶段 提交阶段

## SeataAT模式

一阶段：

1. 解析SQL：得到要执行的SQL语句，分析类型，分析表，条件等相关信息
2. 查询前镜像（改变之前的数据）：根据解析得到的条件信息，生成查询SQL语句，定位数据，得到修改前的数据
3. 执行业务SQL：更新数据
4. 查询后镜像（改变之后的数据）
5. 插入回滚日志：把前后镜像数据以及业务SQL相关的信息组成一条回滚日志记录，插入到UNDO_LOG表中。
6. 提交前，向TC注册分支，申请全局锁。
7. 本地事务提交：业务数据的更新和前面步骤中生成的UNDO LOG一并提交
8. 将本地事务提交的结果上报给TC

二阶段-回滚：

1. 收到TC的分支回滚请求，开启一个本地事务，执行如下操作
2. 通过XID和Branch ID查找对应的UNDO LOG记录。
3. 根据UNDO LOG中的前镜像和业务SQL的相关信息生成并执行回滚的语句（反向补偿SQL语句）
4. 提交本地事务。并把本地事务的执行结果（即分支事务回滚的结果）上报给TC（SeataServer）

二阶段-提交：

1. 收到TC的分支提交请求，把请求放入到一个异步任务的队列中，马上返回提交成功的结果给TC。
2. 提交成功后，清空所有资源。

## Seata源码剖析-AT模式

### Seata客户端启动

首先一个Seata的客户端启动一般分为几个流程：

1. 自动加载各种Bean及配置信息
2. 初始化TM
3. 初始化分布式事务客户端完成，代理数据源
4. 初始化RM（具体服务）
5. 连接TC，注册TM，注册RM
6. 开启全局事务

Seata源码流程图

https://www.processon.com/view/link/6213d58f1e0853078013c58f